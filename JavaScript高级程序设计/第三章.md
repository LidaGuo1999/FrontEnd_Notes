## 第3章 基本概念

### 3.1 语法

ECMAScript（js是它的一个实现）的语法借鉴了许多C语言的语法。

- js的一切都区分大小写；

- 标识符以字母、下划线(_)或者美元符号(\$)开头，由字母、下划线、美元符号或数字组成，一般建议采用驼峰命名法。不允许关键字、保留字、true、false和null用作标识符；

- 单行注释用//，多行注释用/*  */；

- 严格模式是js定义的一种不同的解析与执行模型，某些不确定的行为将得到处理，而且对某些不安全的操作也会抛出错误。在代码顶部或者函数开头都可以指定开启严格模式，添加如下代码即可：

  ```javascript
  "use strict";	// 看起来是字符串，其实是一个编译指示。
  ```

- 语句可以以分号结尾，也可以不加分号由解析器确定结尾。但是为了可读性和安全性，建议还是分号结尾。

### 3.2 关键字和保留字

略

### 3.3 变量

- js的变量是松散类型的，可以用来保存任何类型的数据，且保存的数据类型随时可以根据变量类型更改；

- 使用var操作符定义变量，一条语句可以定义多个变量，只需要逗号隔开，如：

  ```javascript
  var message = 'hi', found = false, age = 29;
  ```

- 使用var定义的变量是局部变量，如果省略var操作符，那么定义的就是全局变量（严格模式下会抛出ReferenceError错误），如：

  ```javascript
  function test() {
  	message = 'hi';	// 全局变量
  }
  ```

### 3.4 数据类型

js中只有6种数据类型，其中5中简单类型Undefined、Null、Boolean、Number和String，1种复杂数据类型Object（本质上就是字典，即一组无序的键值对）。js不支持任何创建自定义类型的机制。

- typeof操作符（注意不是函数）用于检测变量的数据类型，返回值可能是以下几种：

  - undefined：变量类型为Undefined；
  - boolean：变量类型为Boolean；
  - string：变量类型为String；
  - number：变量类型为Number；
  - object：变量类型为Object（非函数）或Null；
  - function：变量类型为Object但其代表一个函数；

  由于typeof为操作符，因此加不加括号都可以：

  ```javascript
  // 下面两个式子等价
  alert(typeof(message));
  alert(typeof message);
  ```

  从技术上看函数是Object，不是一种数据类型，但是函数有一些特殊的属性，因此typeof对其进行区分也是必要的。

- Undefined类型只有一个值，即为undefined，使用var声明变量但是没有初始化时值就是undefined。如果对未声明（不是未初始化）的变量使用typeof，那么结果也是undefined，但是未声明的变量在其他语句中就会导致程序出错。

- Null类型只有一个值，即为null。从逻辑上看，null值表示一个空对象指针。如果定义的变量准备在将来用于保存对象，那么将其初始化为null值是一个很好的选择。同时undefined值从null派生出来的，因此它们在相等性测试中是一样的，即

  ```javascript
  alert(null == undefined); // true
  ```

- Boolean类型取值只有两个：true和false（注意都是小写）。但是它们和数字值不是一回事，true不一定等于非零，false也不一定等于0。Boolean()是一个转型函数，可以对任意的数据类型使用，值的转换规律如下表：

  | 数据类型  | 转换为true的值             | 转换为false的值 |
  | --------- | -------------------------- | --------------- |
  | Boolean   | true                       | false           |
  | String    | 任何非空字符串             | 空字符串        |
  | Number    | 任何非零数字（包括无穷大） | 0和NaN          |
  | Object    | 任何对象                   | null            |
  | Undefined | 无                         | undefined       |

- Number类型可以表示整数和浮点数，支持各种数值类型。

  - 整数中十进制整数直接输入，第一位是0的数字被处理为八进制数（前提是数字中只有0-7，否则将解释为十进制），以0x开头的为十六进制数。

  - 浮点数必须有小数点，小数点前后可以不加数字。但是注意浮点数由于精度问题，有时候相加不一定等于另一个浮点数，因此不要测试某个特定的浮点数值，比如

    ```javascript
    alert(0.1+0.2 == 0.3)	// false
    ```

  - 同样可以使用e或E来表示科学计数法，如3.7e5。

  - Number.MIN_VALUE和Number.MAX_VALUE保存着可以表示的最大和最小值，如果超出该值，那么就会被自动转换为Infinity或者-Infinity值，且这两个值将无法继续参与下一次的计算。isFinite()函数可以确定一个数值是不是有穷的。

  - NaN代表非数值（Not a Number），用于表示一个本来要返回数值的操作数未返回数值的情况，从而不会抛出错误。比如0作分母时结果为NaN。任何涉及NaN的运算都会返回NaN，且NaN与任何值都不相等，包括自己。isNaN()函数可以确定参数是否不是数值，要注意，这个函数会尝试将参数转换为数值，某些本身不是数值的数会被转换为数值，见例子：

    ```javascript
    isNaN(NaN);	// true
    isNaN(10);	// false	本身就是数字10
    isNaN("10");	// false，可以被转换为数字10
    isNaN("blue");	// true
    isNaN(true);	// false，可以被转换为数值1
    ```

    isNan()也可以用于对象，此时会首先调用对象的valueOf()方法，如果方法返回值无法被转换为数值，那么基于这个返回值再调用toString()方法，再测试返回值。其实这个过程也是js中内置函数和操作符的一般执行流程。

  - 将非数值转换为数值有以下三个函数：

    - Number()，又称转型函数，可以用于任何数据类型，规则如下：
      - 对Boolean值，将true和false分别转换为1和0；
      - 对Number值不改变；
      - 对null值，转换为0；
      - 对undefined值，转换为NaN；
      - 对String值，较为复杂，遵循规则如下：
        - 字符串可以直接解释为数值的（包括以0x开头的十六进制数，会被解释为十进制，其余的直接解释（包括整数和浮点数），但是会忽略前导零。
        - 如果字符串为空，转换为0；
        - 如果有除了上述格式之外的字符，则转换为NaN；
      - 对于对象，首先调用valueOf()方法，如果不行再调用toString()方法；
    - parseInt()，将字符串转换为整数的方法。该方法忽略前导空格，从第一个非空格字符开始分析。如果第一个字符不是数字或者负号，直接返回NaN；否则继续分析直到解析完所有后续字符或者遇到一个无效的整数字符为止。有些js引擎可以识别出各种整数格式（十进制、八进制、十六进制），但是不统一，因此建议无论如何指定第二个参数：转换时使用的基数（即进制数）。
    - parseFloat()，将字符串转换为浮点数的方法。和上述一样，从第一个非空格字符开始分析，直到结束或者遇到无效的浮点数字字符为止。注意该方法只能够识别十进制的值，因此没有基数作为第二个参数。如果待转换的字符串包含的是一个可以解析为整数的数（没有小数点，或者小数点后均为0），那么该方法会返回一个整数。

- String类型表示字符串，用单引号或者双引号包裹所表示。

  - 在js中，字符串是不可变的，一旦创建，其值就无法改变。因此在给变量赋一个新的String值时，后台会首先销毁原来的字符串，然后用新的字符串填充该变量。
  - 将其他类型的值转换为String有两种形式：
    - toString()，这是几乎（Null和Undefined类型的值没有）每个值都有的方法。对于数值来说，还可以传入一个参数指定转换的基数，默认是十进制。
    - String()转型函数，可以将任何类型的值转换为字符串，规则如下：
      - 如果值有toString()方法，就调用该方法；
      - 如果值为null或undefined，则返回“null”或“undefined”；

- Object类型是ECMAScript中一组数据和功能的集合，通过执行new操作符后跟要创建的对象类型的名称来创建，如

  ```javascript
  var o = new Object();
  var o = new Object;	// 如果不给构造函数传递参数，则括号可以省略，不过不建议
  ```

  - 可以将Object看作是一个基类，是所有它的实例的基础，每个实例都要求实现以下属性和方法：
    - Constructor：保存着用于创建当前对象的函数，是一个属性；
    - hasOwnProperty(propertyName)：检查给定的属性（以字符串形式传入）在当前的对象实例中（而不是实例的原型中）是否存在；
    - isPrototypeOf(object)：检查传入的对象是否是另一个对象的原型；
    - propertyIsEnumerable(propertyName)：检查给定的属性（以字符串形式传入）是否能够迭代枚举（即能否使用for-in语句）；
    - toLocaleString()：返回对象的字符串表示，与执行环境的地区对应；
    - toString()：返回对象的字符串表示；
    - valueOf()：返回对象的字符串、数值或者布尔值表示，一般和toString()的返回值相同；
  - 不过由于上述对象是ECMAScript中的规定，在js中其他对象不一定遵守，比如浏览器环境中的一些对象（即宿主对象，由宿主实现提供和支持），它们可能不会继承Object。

### 3.5 操作符

ECMAScript中操作符的与众不同之处在于能够适用于很多类型的值，只不过可能会调用valueOf()或者toString()方法。

- 一元操作符
  - 递增（++）和递减（--）：前置/后置用法与C一样，不过对于非数值变量，遵循如下规则：
    - 包含有效数字字符的字符串会先被转换为数值，然后进行操作，最终结果为数值类型；
    - 不包含有效数字字符的字符串会被转换为NaN，最终结果为数值类型；
    - true或者false值都将先被转换为1或0，再进行计算，最终结果为数值类型；
    - 浮点数正常运算；
    - 对象，首先调用valueOf()，如果结果为NaN，那么再调用toString()后使用上述规则，最终结果为数值类型；
  - 加（+）和减（-）：类似数学的正负号，与数学中完全相同。非数值类型会先按Number()转型函数的规则转换为数值，再添加正负号。因此，不仅可以用于基本的算术运算，也可以用于转换数据类型；
  
- 位操作符：ECMAScript中所有数字实际上都以64位存储，但位操作符计算时会先将64位转换为32位，得到结果后再还原回64位。默认时ECMAScript都是有符号整数，第31位（即最高位）是符号位。不过这导致一个严重的副作用，即如果对NaN和Infinity使用位操作符时，这两个值会被当成0处理。如果对非数值类型使用，则先利用Number()进行转型。
  - 按位非：~
  - 按位与：&
  - 按位或：|
  - 异或：^，当二者只有1个1时结果为1
  - 左移：<<，填充0
  - 有符号右移：>>，填充符号位
  - 无符号右移：>>>，填充0
  
- 布尔操作符：
  - 逻辑非：!，将操作数先转换为布尔类型再运算
  - 逻辑与：&&，短路操作，可以应用于任何类型的操作数，但是在有一个操作数不是布尔值的情况下，返回值不一定为布尔值：
    - 如果第一个为对象，则返回第二个操作数；
    - 如果第二个为对象，那么只有在第一个操作数为true时才返回该对象；
    - 如果两个均为对象，则返回第二个操作数（和第一条其实一样）；
    - 如果有一个操作数为null、NaN或undefined，则返回null、NaN或undefined（如果二者均为这三类，则取第一个操作数）；
  - 逻辑或：||，可以应用于任何类型的操作数，但是在有一个操作数不是布尔值的情况下，返回值不一定为布尔值：
    - 如果第一个为对象，则返回第一个操作数；
    - 如果第一个为false，则返回第二个操作数；
    - 如果两个均为对象，则返回第二个操作数（和第一条其实一样）；
    - 如果两个操作数均为null、NaN或undefined，则返回null、NaN或undefined（如果二者均为这三类，则取第二个操作数）；
  
- 乘性操作符：与其他语言中类似，只不过在操作数为非数值时会自动进行类型转换。
  - 乘法：*，特殊值处理：
    - 超过表示范围，返回Infinity或-Infinity；
    - 有一个是NaN，则返回NaN；
    - Infinity和0相乘返回NaN，和非0相乘，结果是Infinity或者-Infinity；
  - 除法：/，特殊值处理：
    - 超过表示范围，返回Infinity或-Infinity；
    - 有一个是NaN，返回NaN；
    - 0/0或者Infinity/Infinity，返回NaN；
    - 非0数/0，返回Infinity或者-Infinity；
    - 非Infinity数/Infinity，返回0；
  - 求模：%，特殊值处理：
    - 被除数为Infinity，则结果为NaN；
    - 被除数为0时，仅当除数也为0时返回NaN，其他均返回0；
    - 除数为Infinity，返回被除数（除了被除数为Infinity时返回NaN）；
    - 除数为0时，均返回NaN；
  
- 加性操作符：与乘性操作符类似，也会在后台转换不同的数据类型，不过规则有些复杂。

  - 加法：+，特殊值处理：
    - 有一个操作数是NaN，则结果为NaN；
    - Infinity加Infinity是Infinity，-Infinity加-Infinity是-Infinity，Infinity加-Infinity是NaN；
    - +0加+0是+0，-0加-0是-0，+0加-0是+0；
    - 只要其中有一个操作数是字符串，另一个操作数也会根据规则转换为字符串后进行拼接；
  - 减法：-，特殊值处理：
    - 有一个操作数是NaN，则结果为NaN；
    - Infinity减Infinity是NaN，-Infinity减-Infinity是NaN，Infinity减-Infinity是Infinity，-Infinity减Infinity是-Infinity；
    - +0减+0是+0，+0减-0是-0，-0减-0是+0；
    - 当操作数是非数值类型时，后台会根据规则将其转换为数值再进行运算；

- 关系操作符：返回值是布尔值，包含小于(<)，大于(>)，小于等于(<=)，大于等于(>=)。

  - 特殊规则如下：
    - 如果两个操作数都是字符串，那么比较对应的字符编码值；
    - 否则将操作数都转换为数值进行比较；
    - 若是有一个操作数为NaN，那么结果都为false；

- 相等操作符：有两组操作符，相等和全等。

  - 相等和不相等：==和!=，是先转换类型，再进行比较，特殊规则如下：
    - 布尔类型的值会先转换为数值再进行比较；
    - 如果一个操作数是字符串，另一个是数值，那么字符串转换为数值；
    - 如果一个操作数是对象，另一个不是，那么对象调用valueOf()方法；
    - 如果两个操作数都是对象，则比较的是是否指向同一对象；
    - null和undefined是相等的；
    - 只要有一个操作数是NaN，则==返回false，!=返回true（就算两个都是NaN结果也不变）；
  - 全等和不全等：\=\=\=和!\=\=，不转换类型，全等只在操作数未经转换就相等的情况下返回true。
  - 为了保持代码中数据类型的完整性和安全性，一般建议使用全等和不全等；

- 条件操作符：与Java中语法形式相同，即：

  ```javascript
  variable = boolean_expression ? true_value : false_value;
  ```

- 赋值操作符：用=号表示，支持复合赋值操作，如+=，-=之类。

- 逗号操作符：在一条语句中执行多个操作，如：

  ```javascript
  var num1 = 1, num2 = 2, num3 = 3;
  ```

### 3.6 语句

- if语句：基本相同，用if，else if，else来控制；

- do-while语句：同C；

- while语句：同C；

- for语句：同C；

- for-in语句：精准的迭代语句，语法是：

  ```javascript
  for (property in expression) statement
  ```

  如果迭代的对象是null或者undefined，那么语句会抛出错误或者只是不再执行循环体；

- label语句：添加标签，在将来可以被break或continue引用，语法：

  ```javascript
  label: statement
  ```

- break和continue语句：基本同C，但是可以与label语句一起使用，一般发生在循环多层嵌套想直接break至外循环或者continue至外循环时；

- with语句：将代码的作用域设置到一个特定的对象中，语法为：

  ```javascript
  with (expression) statement
  ```

  严格模式下不允许使用with语句，一般不建议使用with语句，因为会给代码调试造成困难；

- switch语句：基本同C，使用的是全等，每个case的值可以是任何数据类型，也不仅仅是常量，可以是变量甚至是表达式；

### 3.7 函数

函数的语法如下：

```javascript
function functionName(arg0, arg1,...,argN) {
	statements   
}
```

不必指定返回值，但是可以使用return语句，如果return语句不带任何返回值，即返回undefined；

- 参数的理解：
  - js中所有参数都是传递值的，没有传递引用的参数；
  - js中传入函数内部的参数都是用arguments对象来表示，这个对象可以使用类似数组的方法取值，但是其不是数组的实例。可以用length属性确定传进来多少个参数，因此传入函数的实际参数个数和定义时的参数个数可以完全不一样，给参数的命名只是提供便利，但不是必需的；
  - 另外命名参数可以和arguments对象一起使用；
  - arguments的值永远和对应的命名参数保持同步（各自的内存仍旧是独立的，只是值会同步），但这种影响是单向的：修改命名参数是不会改变arguments的值的，只有修改arguments的值才会修改命名参数的值；
  - 没有传递值的命名参数为undefined；
- 没有重载：因为js中的函数接受的参数是由包含零个或多个值的类数组对象arguments存储的，因此不具备利用函数签名（接受的参数的类型和数量）进行重载的条件。所以js中如果定义了两个名字相同的函数，则采用后定义的函数。
